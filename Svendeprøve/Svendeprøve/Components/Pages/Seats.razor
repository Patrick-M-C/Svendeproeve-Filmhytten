@page "/Seats"
@using Svendeprøve.Components.Models
@using Svendeprøve.Components.Services
@rendermode InteractiveServer
@inject HallService HallService
@inject NavigationManager NavigationManager

<h1>Sæder i hal</h1>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-center text-danger">@errorMessage</p>
}

@if (hall == null || seats == null)
{
    <p class="text-center">Indlæser sæder...</p>
}
else
{
    <div class="hall-container">
        <div class="hall">
            <h3>@hall.Name (@hall.SeatCount sæder)</h3>
            <div class="screen"></div>
            <!-- Række- og sædenumre -->
            <div class="seat-labels">
                <div class="row-labels">
                    @foreach (var row in seats.Select(s => s.Row).Distinct().OrderBy(r => r))
                    {
                        <div class="row-label">Række @row</div>
                    }
                </div>
                <div class="seats" style="grid-template-columns: repeat(@GetColumns(seats), 30px);">
                    @foreach (var seat in seats.OrderBy(s => s.Row).ThenBy(s => s.SeatNumber))
                    {
                        <div class="seat @(seat.IsReserved ? "reserved" : "available")"
                             title="Række @seat.Row, Sæde @seat.SeatNumber">
                        </div>
                    }
                </div>
            </div>
            <div class="seat-info">
                <p>@seats.Count(s => !s.IsReserved) ud af @hall.SeatCount sæder er tilgængelige.</p>
                <button class="btn btn-primary" @onclick="ConfirmBooking">Bekræft Booking</button>
            </div>
        </div>
    </div>
}

@code {
    private Hall? hall;
    private List<Seat>? seats;
    private string? errorMessage;
    private int? hallId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            if (query["hallId"] == null || !int.TryParse(query["hallId"], out var parsedHallId))
            {
                errorMessage = "Ingen hal valgt. Angiv en hal.";
                Console.WriteLine(errorMessage);
                return;
            }
            hallId = parsedHallId;

            hall = await HallService.GetHallByIdAsync(hallId.Value);
            if (hall == null)
            {
                errorMessage = "Ingen haller fundet i databasen.";
                Console.WriteLine(errorMessage);
                seats = new List<Seat>();
                return;
            }

            seats = hall.Seats;
            if (seats == null || !seats.Any())
            {
                errorMessage = $"Ingen sæder fundet for hal {hall.Name}.";
                Console.WriteLine(errorMessage);
            }
            else
            {
                Console.WriteLine($"Loaded hall: {hall.Name} (ID: {hall.Id}) with {seats.Count} seats, {seats.Count(s => !s.IsReserved)} available");
            }
        }
        catch (HttpRequestException ex)
        {
            errorMessage = $"Kunne ikke hente sæder: {ex.Message}";
            Console.WriteLine(errorMessage);
            seats = new List<Seat>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Uventet fejl: {ex.Message}";
            Console.WriteLine(errorMessage);
            seats = new List<Seat>();
        }
    }

    private async Task ConfirmBooking()
    {
        try
        {
            if (hall == null)
            {
                errorMessage = "Ingen hal valgt.";
                Console.WriteLine(errorMessage);
                return;
            }

            if (seats == null || !seats.Any(s => !s.IsReserved))
            {
                errorMessage = "Ingen tilgængelige sæder i denne hal.";
                Console.WriteLine(errorMessage);
                return;
            }

            Console.WriteLine($"Booking confirmed for hall ID: {hall.Id}, 1 seat reserved");

            errorMessage = null;
            StateHasChanged();

            // Naviger til Confirmation-siden
            NavigationManager.NavigateTo("/Confirmation");
            errorMessage = null;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Fejl ved bekræftelse af booking: {ex.Message}";
            Console.WriteLine(errorMessage);
            StateHasChanged();
        }
    }

    private int GetColumns(List<Seat> seats)
    {
        return seats.Any() ? seats.GroupBy(s => s.Row).Max(g => g.Count()) : 1;
    }
}

<style>
    .hall-container {
        display: flex;
        justify-content: center;
        padding: 20px;
    }

    .hall {
        text-align: center;
    }

    .screen {
        width: 300px;
        height: 20px;
        background-color: #666;
        margin: 0 auto 20px;
    }

    .seat-labels {
        display: flex;
    }

    .row-labels {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        margin-right: 10px;
    }

    .row-label {
        height: 30px;
        line-height: 30px;
        font-size: 14px;
        color: #333;
    }

    .seats {
        display: grid;
        gap: 5px;
        justify-content: center;
    }

    .seat {
        width: 30px;
        height: 30px;
        border: 1px solid #ccc;
        transition: all 0.2s ease;
    }

        .seat.available {
            background-color: #90EE90; /* Ledige sæder (grøn) */
        }

        .seat.reserved {
            background-color: #ff5555; /* Reserverede sæder (rød) */
        }

    .seat-info {
        margin-top: 20px;
        font-size: 16px;
    }

    .btn-primary {
        padding: 10px 20px;
        font-size: 16px;
        background-color: #007bff;
        border-color: #007bff;
    }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

    .text-danger {
        color: #dc3545; /* Bootstrap rød farve til fejl */
    }
</style>